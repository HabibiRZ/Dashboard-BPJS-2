<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Top & Bottom Potensi Iuran — Medan Kota</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --color-primary:#004c99; --color-secondary:#0066cc; --color-green:#28a745;
      --color-yellow-accent:#ffc107; --color-background:#f0f3f6; --color-surface:#ffffff;
      --color-text-dark:#333333; --color-text-light:#ffffff;
      --box-shadow:0 4px 12px rgba(0,0,0,0.08); --border-radius:12px;
      --font-family:'Roboto','Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
    }
    *{ box-sizing:border-box }
    body{
      font-family:var(--font-family); background:var(--color-background); color:var(--color-text-dark);
      min-height:100vh; padding:20px; overflow-x:hidden;
    }
    .container{ max-width:1400px; margin:0 auto; display:flex; flex-direction:column; gap:18px; }

    header{
      display:flex; align-items:center; justify-content:space-between;
      background:var(--color-surface); padding:10px 20px; box-shadow:var(--box-shadow);
      border-radius:var(--border-radius);
    }
    .header-section{ display:flex; align-items:center; gap:12px; }
    .header-logo{ height:70px; border-radius:8px; }
    .header-title{ text-align:center; }
    .header-title h1{ font-size:1.4rem; color:var(--color-primary); margin:0; font-weight:700 }
    .header-title p{ margin:4px 0 0; font-weight:500; font-style:italic }

    .top-bar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                background-color: var(--color-green);
                color: var(--color-text-light);
                padding: 8px 15px;
                margin-bottom: 10px;
                font-weight: 500;
                border-radius: var(--border-radius);
                box-shadow: var(--box-shadow);
    }
    .nav-button {
            display: inline-block;
            margin-left: 10px;
            margin-bottom: 10px;
            padding: 10px 12px;
            font-size: 1.5em;
            color: #fff;
            background-color: #004c99; 
            border-radius: 6px;
            text-decoration: none;
            transition: background 0.3s;
        }

    .nav-button:hover {
            background-color: #0066cc;
    }

    .status-indicator{ padding:4px 8px; border-radius:4px; font-size:.85rem; font-weight:700; text-transform:uppercase }
    .status-loading{ background:#fff3cd; color:#856404 }
    .status-online{ background:#d4edda; color:#155724 }
    .status-error{ background:#f8d7da; color:#721c24 }

    h2{ font-size:1.2rem; color:var(--color-primary); text-align:center; margin:0 0 8px }

    .grid{
      display:grid; grid-template-columns:1fr 1fr; gap:16px;
    }
    .panel{
      background:var(--color-surface); border-radius:var(--border-radius); box-shadow:var(--box-shadow);
      padding:12px; overflow:hidden; display:flex; flex-direction:column;
    }
    .table-wrap{ overflow:auto; max-height:70vh; border:1px solid #edf2f7; border-radius:10px }
    .table-green thead th{
    background: linear-gradient(135deg, #28a745, #20c997);
    }
    .table-green tbody tr:hover{ background:#e8f5e9; }
    .table-red thead th{
    background: linear-gradient(135deg, #dc3545, #e35d6a);
    }
    .table-red tbody tr:hover{ background:#fdecea; }
    table{ width:100%; border-collapse:collapse; min-width:780px }
    thead th{
      position:sticky; top:0; z-index:2; background:linear-gradient(135deg,var(--color-primary),#0056b3);
      color:var(--color-text-light); text-transform:uppercase; letter-spacing:.3px; font-size:.85rem;
      padding:10px 12px; text-align:left; white-space:nowrap;
    }
    td{ padding:8px 12px; border-bottom:1px solid #edf2f7 }
    tbody tr:nth-child(even){ background:#f8fafc }
    tbody tr:hover{ background:#edf2f7 }

    .instansi-link{
        color: var(--color-secondary);
        font-weight: 600;
        text-decoration: none;
    }

    .instansi-link:hover{
        color: var(--color-primary);
        text-decoration: underline;
    }
    .num{ text-align:center; width:56px }
    .val, .idr{ text-align:right; white-space:nowrap }
    .sub{ font-size:.82rem; color:#666; margin-top:2px }

    .badge{
      display:inline-block; padding:3px 8px; border-radius:999px; font-size:.78rem; font-weight:600;
      background:#e8f0fe; color:var(--color-primary)
    }

    .header-bar{
                width: 180px;
                margin-left: 15px;
                margin-right: 15px;
                margin-top: 10px;
    }

    @media (max-width: 900px){
      .grid{ grid-template-columns:1fr; }
      .header-title{ display:none }
      .top-bar{ flex-direction:column; gap:6px; align-items:flex-start }
    }

    .loading-spinner{
      border:4px solid #f3f3f3; border-top:4px solid var(--color-primary);
      border-radius:50%; width:36px; height:36px; animation:spin 1s linear infinite; margin:14px auto;
    }
    @keyframes spin{ 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-section">
        <img src="medan.png" class="header-logo" alt="Logo Kota Medan">
        <img src="pemprovsu.png" class="header-logo" alt="Logo Pemprovsu">
      </div>
      <div class="header-title">
        <h1>Top & Bottom Potensi Iuran — Medan Kota</h1>
        <p>(Sumber data: LKPP / Google Sheets)</p>
      </div>
      <div class="header-section">
        <img src="logo.png" class="header-logo" alt="BPJS Ketenagakerjaan">
      </div>
    </header>

    <div class="top-bar">
      <div class="top-bar-left">
        <span id="currentDate"></span>
        <span id="connectionStatus" class="status-indicator status-loading">Memuat…</span>
      </div>
      <div class="top-bar-right">
        <a href="index.html" class="nav-button">Home</a>
        <a href="topworst.html" class="nav-button">Top Worst</a>
        <img src="sumutberkah.png" alt="Walikota Medan" class="header-bar">
        <img src="medanutksemua.png" alt="Walikota Medan" class="header-bar">
        <span style="font-size: 0.9em;">Data dari Google Sheets</span>
      </div>
    </div>

    <div class="grid">
      <!-- TOP 10 -->
      <section class="panel">
        <h2>Top 10 Potensi Iuran Tertinggi <span class="badge" id="badgeTopCount">0 instansi</span></h2>
        <div class="table-wrap" id="topWrap">
            <table id="topTable" class="table-green">
            <thead>
                <tr>
                <th class="num">No.</th>
                <th>Instansi</th>
                <th class="num">Jml Proyek</th>
                <th class="idr">Total Nilai Proyek</th>
                <th class="idr">Total Potensi Iuran</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="5"><div class="loading-spinner"></div></td></tr>
            </tbody>
            </table>
        </div>
      </section>

      <!-- BOTTOM 10 -->
      <section class="panel">
        <h2>Bottom 10 Potensi Iuran Terendah <span class="badge" id="badgeBottomCount">0 instansi</span></h2>
        <div class="table-wrap" id="bottomWrap">
            <table id="bottomTable" class="table-red">
            <thead>
                <tr>
                <th class="num">No.</th>
                <th>Instansi</th>
                <th class="num">Jml Proyek</th>
                <th class="idr">Total Nilai Proyek</th>
                <th class="idr">Total Potensi Iuran</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="5"><div class="loading-spinner"></div></td></tr>
            </tbody>
            </table>
        </div>
        </section>
    </div>
  </div>

  <script>
    const SHEET_CONFIG = {
      sheetId: "1lC89S6QlNALlqLHhaYYmIm1qPgd_-24n6ZUwUsPve5o",
      apiKey: "AIzaSyDDChj-Syqytv2HboLnbflQu7-u_5VAYIE",
      range: "A2:M1000"
    };

    function formatCurrency(amount){
      return new Intl.NumberFormat('id-ID', { style:'currency', currency:'IDR', minimumFractionDigits:0, maximumFractionDigits:0 }).format(amount || 0);
    }
    function cleanCurrencyValue(value) {
    if (typeof value === 'number') return value;
if (typeof value === 'string') {
    // Handle format singkatan (misal: "44.487" berarti 44.487.000.000)
    if (value.includes('.') && !value.includes(',')) {
        const parts = value.split('.');
        // Jika hanya ada 1 titik, kemungkinan ini format singkatan (ribuan juta)
        if (parts.length === 2) {
            const angka = parseFloat(value.replace(/\./g, ''));
            return angka * 1000000; // Kalikan dengan 1 juta
        }
    }
    
    // Format normal, hapus karakter non-numeric
    const cleaned = value.replace(/[^\d,-]/g, '').replace(',', '.');
    const parsed = parseFloat(cleaned) || 0;
    return parsed;
}
return 0;
}
    // Pakai skema tier yang sama dengan index.html
    function computePotensiIuran(amount){
      const tiers = [
        { cap: 100_000_000, rate: 0.0024 },
        { cap: 500_000_000, rate: 0.0019 },
        { cap: 1_000_000_000, rate: 0.0015 },
        { cap: 5_000_000_000, rate: 0.0012 },
        { cap: Infinity, rate: 0.0010 }
      ];
      let premi = 0, prevCap = 0;
      for (const t of tiers){
        const usable = Math.max(0, Math.min(amount, t.cap) - prevCap);
        if (usable <= 0){ prevCap = t.cap; continue; }
        premi += usable * t.rate;
        prevCap = t.cap;
        if (prevCap >= amount) break;
      }
      return premi;
    }

    function updateCurrentDate(){
      const now = new Date();
      const options = { day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit', timeZone:'Asia/Jakarta' };
      document.getElementById('currentDate').textContent = now.toLocaleDateString('id-ID', options);
    }
    function setStatus(type, msg){
      const el = document.getElementById('connectionStatus');
      el.className = 'status-indicator status-' + type;
      el.textContent = msg;
    }
    function showError(message){
      const div = document.createElement('div');
      div.innerHTML = `
        <div style="position:fixed;top:20px;right:20px;background:#dc3545;color:#fff;padding:12px 14px;border-radius:8px;z-index:10000;box-shadow:0 4px 12px rgba(0,0,0,.3)">
          <strong>Error:</strong> ${message}
          <button onclick="this.parentElement.remove()" style="float:right;background:none;border:none;color:#fff;font-size:18px;cursor:pointer;margin-left:10px">&times;</button>
        </div>`;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 5000);
    }

    async function fetchGoogleSheetsData(){
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_CONFIG.sheetId}/values/${SHEET_CONFIG.range}?key=${SHEET_CONFIG.apiKey}`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const json = await resp.json();
      const rows = json.values || [];
      // Map ke struktur proyek + hitung potensi per baris
      const data = rows.map((row, idx) => {
        const nilai = cleanCurrencyValue(row[5] || '0');
        return {
          no: row[0] || (idx + 1).toString(),
          kodeRup: row[1] || '',
          kodeTender: row[2] || '',
          kodeProyek: row[3] || '',
          namaProyek: row[4] || '',
          nilaiProyek: nilai,
          sumberDana: row[6] || 'Tidak Diketahui',
          namaPemilik: row[7] || 'Tidak Diketahui',
          namaInstansi: row[8] || 'Tidak Diketahui',
          namaPelaksana: row[9] || '',
          sumberPotensi: row[10] || '',
          statusPotensi: row[11] || 'Tidak Diketahui',
          tglSpmk: row[12] || '',
          potensiIuran: computePotensiIuran(nilai)
        };
      }).filter(p => p.namaProyek && p.namaProyek.trim() !== '' && p.namaProyek !== 'Tidak Diketahui');
      return data;
    }

    function renderAggTable(tbodyEl, list){
    tbodyEl.innerHTML = '';
    list.forEach((it, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
        <td class="num">${i+1}</td>
        <td>
            <a class="instansi-link"
            href="detail.html?instansi=${encodeURIComponent(it.instansi)}"
            title="Lihat detail proyek untuk ${it.instansi}">
            ${it.instansi}
            </a>
        </td>
        <td class="num">${it.count.toLocaleString('id-ID')}</td>
        <td class="idr">${formatCurrency(it.totalNilai)}</td>
        <td class="idr">${formatCurrency(it.totalPotensi)}</td>
        `;
        tbodyEl.appendChild(tr);
    });
    }

    async function loadAndRender(){
    updateCurrentDate();
    setStatus('loading','Memuat data…');
    try{
        const rows = await fetchGoogleSheetsData();

        // --- Agregasi per instansi ---
        const byInstansi = new Map();
        rows.forEach(p => {
        const key = p.namaInstansi || 'Tidak Diketahui';
        const pot = p.potensiIuran || 0;
        const nilai = p.nilaiProyek || 0;

        if(!byInstansi.has(key)){
            byInstansi.set(key, { instansi: key, count: 0, totalNilai: 0, totalPotensi: 0 });
        }
        const agg = byInstansi.get(key);
        agg.count += 1;
        agg.totalNilai += nilai;
        agg.totalPotensi += pot;
        });

        const aggList = Array.from(byInstansi.values());

        // Urutkan berdasarkan totalPotensi (DESC untuk Top, ASC untuk Bottom)
        const top10 = [...aggList].sort((a,b) => b.totalPotensi - a.totalPotensi).slice(0,10);
        const bottom10 = [...aggList].sort((a,b) => a.totalPotensi - b.totalPotensi).slice(0,10);

        // Render
        renderAggTable(document.querySelector('#topTable tbody'), top10);
        renderAggTable(document.querySelector('#bottomTable tbody'), bottom10);

        // Badge
        document.getElementById('badgeTopCount').textContent = `${top10.length} instansi`;
        document.getElementById('badgeBottomCount').textContent = `${bottom10.length} instansi`;

        setStatus('online', `${rows.length} baris proyek • ${aggList.length} instansi`);
    }catch(err){
        console.error(err);
        setStatus('error','Gagal memuat data');
        showError('Gagal memuat data dari Google Sheets. Silakan coba lagi.');
    }
    }


    document.addEventListener('DOMContentLoaded', () => {
      loadAndRender();
      // Auto refresh tiap 5 menit biar konsisten dengan index.html
      setInterval(loadAndRender, 5 * 60 * 1000);
    });
  </script>
</body>
</html>
